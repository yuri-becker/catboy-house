networks:
  "{{ nextcloud_network_name }}":
    name: "{{ nextcloud_network_name }}"
  "{{ auth_ldap_network }}":
    name: "{{ auth_ldap_network }}"
    external: true

services:
  mariadb:
    image: mariadb:10
    container_name: "{{ nextcloud_mariadb_container_name }}"
    restart: unless-stopped
    user: "{{ nextcloud_uid }}"
    networks:
      - "{{ nextcloud_network_name }}"
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - "{{ nextcloud_volume_mariadb }}:/var/lib/mysql"
    environment:
      MYSQL_ROOT_PASSWORD: "{{ nextcloud_mariadb_root_password }}"
      MYSQL_USER: "{{ nextcloud_mariadb_user }}"
      MYSQL_PASSWORD: "{{ nextcloud_mariadb_password }}"
      MYSQL_DATABASE: nextcloud

  keydb:
    image: eqalpha/keydb:latest
    container_name: "{{ nextcloud_keydb_container_name }}"
    restart: unless-stopped
    user: "{{ nextcloud_uid }}"
    networks:
      - "{{ nextcloud_network_name }}"
    command: keydb-server --appendonly yes
    volumes:
      - "{{ nextcloud_volume_keydb }}:/data"

  onlyoffice:
    image: onlyoffice/documentserver:latest
    container_name: "{{ nextcloud_onlyoffice_container_name }}"
    ports:
      - "{{ docker_gateway }}:{{ nextoffice_onlyoffice_port }}:80"
    networks:
      - "{{ nextcloud_network_name }}"
    volumes:
      - "{{ nextcloud_volume_onlyoffice }}:/var/www/onlyoffice/Data"
    environment:
      JWT_SECRET: "{{ nextcloud_onlyoffice_secret }}"

  nextcloud:
    image: nextcloud:latest
    container_name: "{{ nextcloud_nextcloud_container_name }}"
    restart: unless-stopped
    depends_on:
      - mariadb
      - keydb
    ports:
      - "{{ docker_gateway }}:{{ nextcloud_port }}:80"
    volumes:
      - "{{ nextcloud_volume_nextcloud }}:/var/www/html"
    networks:
      - "{{ nextcloud_network_name }}"
      - "{{ auth_ldap_network }}"
    environment:
      MYSQL_HOST: mariadb
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: "{{ nextcloud_mariadb_user }}"
      MYSQL_PASSWORD: "{{ nextcloud_mariadb_password }}"
      REDIS_HOST: keydb
      SMTP_HOST: "{{ smtp_server }}"
      SMTP_PORT: "{{ smtp_port }}"
      SMTP_NAME: "{{ nextcloud_smtp_user }}"
      SMTP_PASSWORD: "{{ nextcloud_smtp_password }}"
      MAIL_FROM_ADDRESS: "{{ nextcloud_smtp_user }}"
