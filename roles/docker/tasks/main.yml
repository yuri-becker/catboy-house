---
# tasks for docker
- name: ğŸ“¦ Installs docker and components
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop:
    - docker-ce
    - docker-ce-cli
    - docker-compose-plugin
  become: true

- name: ğŸš€ Starts docker service
  ansible.builtin.systemd_service:
    name: docker
    enabled: true
    state: started
  become: true

- name: â¬†ï¸ Pushes daemon.json
  ansible.builtin.copy:
    src: daemon.json
    dest: /etc/docker/daemon.json
    mode: "0755"
    owner: root
    group: root
  become: true
  notify: restart docker

- name: ğŸ‘¤ Creates Docker Build User
  ansible.builtin.user:
    state: present
    name: "{{ docker_build_user }}"
    uid: "{{ docker_build_uid }}"
    create_home: true
    groups:
      - docker
  become: true

- name: âš™ï¸ Sets up Cronjob
  ansible.builtin.include_role:
    name: cronjob
    public: false
  vars:
    cronjob_name: docker prune
    cronjob_special_time: weekly
    cronjob_command: docker image prune -f
    cronjob_user: "{{ docker_build_user }}"
    cronjob_notification_avatar: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/docker.png"
    cronjob_notification_as: Docker Prune (weekly)

- name: ğŸ” Inspect Docker Bridge Network
  community.docker.docker_network_info:
    name: bridge
  register: docker_bridge_network_info

- name: ğŸ’¾ Sets docker_gateway fact
  ansible.builtin.set_fact:
    docker_gateway: "{{ docker_bridge_network_info.network.IPAM.Config[0].Gateway }}"
