---
- name: ğŸ‘¤ Creates user
  ansible.builtin.user:
    state: present
    name: "{{ beszel_user }}"
    uid: "{{ beszel_uid }}"
    create_home: true
    home: "{{ beszel_path }}"
    groups:
      - "{{ app_gid }}"
      - docker
  become: true

- name: ğŸ“‚ Creates volumes
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    mode: "0700"
  loop:
    - "{{ beszel_data_hub }}"
    - "{{ beszel_data_agent }}"
  become: true
  become_user: "{{ beszel_user }}"

- name: ğŸ“‚ Creates stat directory
  ansible.builtin.file:
    state: directory
    path: "/home/.beszel"
    mode: "0755"
    owner: "{{ beszel_user }}"
    group: "{{ app_gid }}"
  become: true

- name: â¬†ï¸ Pushes compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel_path }}/docker-compose.yml"
    mode: "0770"
    group: "{{ app_gid }}"
  become: true

- name: ğŸš€ Starts container stack
  community.docker.docker_compose_v2:
    project_src: "{{ beszel_path }}"
    state: present
  become: true

- name: â¬†ï¸ Pushes Caddy config
  ansible.builtin.template:
    src: beszel.caddy.j2
    dest: "{{ caddy_sites }}/beszel.caddy"
    mode: "0770"
    group: "{{ app_gid }}"
  notify: reload caddy
