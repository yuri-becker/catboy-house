services:
  hub:
    image: henrygd/beszel:latest
    container_name: "{{ beszel_hub_container }}"
    restart: unless-stopped
    user: "{{ beszel_uid }}:{{ app_gid }}"
    ports:
      - "{{ docker_gateway }}:{{ beszel_port }}:8090"
    volumes:
      - "{{ beszel_data_hub }}:/beszel_data"
      - "{{ beszel_socket }}:/beszel_socket"
    environment:
      DISABLE_PASSWORD_AUTH: true
    healthcheck:
      test: ['CMD', '/beszel', 'health', '--url', 'http://localhost:8090']
      start_period: 20s 
      interval: 120s 

  agent:
    image: henrygd/beszel-agent:latest
    container_name: "{{ beszel_agent_container }}"
    restart: unless-stopped
    network_mode: host
    user: "{{ beszel_uid }}:{{ docker_gid }}"
    volumes:
      - "{{ beszel_data_agent }}:/var/lib/beszel-agent"
      - "{{ beszel_socket }}:/beszel_socket"
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /home/.beszel:/extra-filesystems/md3_home:ro
    environment:
      LISTEN: /beszel_socket/beszel.sock
      HUB_URL: http://{{ docker_gateway }}:{{ beszel_port }}
      TOKEN: "{{ beszel_local_agent_token }}"
      KEY: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC1lKomZ3NnO+FkNe3xH1YvIWAm+7kPJJuSe+wPYkEDM"
      SKIP_GPU: true
      interval: 120s
    healthcheck:
      test: ['CMD', '/agent', 'health']
